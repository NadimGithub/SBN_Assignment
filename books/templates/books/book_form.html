{% extends "books/base.html" %}
{% block title %}{{ action }} Book{% endblock %}
{% block content %}

<div class="card mx-auto shadow-sm p-4" style="max-width: 600px;">
  <h3 class="text-center text-primary mb-4">{{ action }} Book</h3>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- ISBN -->
    <div class="mb-3">
      <label class="form-label fw-semibold">ISBN (optional)</label>
      <div class="input-group">
        {{ form.isbn }}
        <button id="fetch-btn" type="button" class="btn btn-outline-primary">
          <i class="fa fa-search"></i> Fetch by ISBN
        </button>
      </div>
      <small class="text-muted">Click “Fetch by ISBN” to auto-fill Title and Author from OpenLibrary.</small>
    </div>

    <!-- Title -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Title</label>
      {{ form.title }}
    </div>

    <!-- Author -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Author</label>
      {{ form.author }}
    </div>

    <!-- Price -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Price</label>
      {{ form.price }}
    </div>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary px-4">
        <i class="fa fa-save"></i> {{ action }}
      </button>
      <a href="{% url 'books:book_list' %}" class="btn btn-secondary px-4">
        <i class="fa fa-arrow-left"></i> Cancel
      </a>
    </div>
  </form>
</div>

<script>
document.getElementById('fetch-btn').addEventListener('click', function() {
  const isbnInput = document.getElementById('id_isbn');
  const isbn = isbnInput.value.trim();

  if (!isbn) {
    alert('Please enter an ISBN first!');
    return;
  }

  fetch("{% url 'books:fetch_openlibrary' %}?isbn=" + encodeURIComponent(isbn))
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        document.getElementById('id_title').value = data.title || '';
        document.getElementById('id_author').value = data.author || '';
      }
    })
    .catch(() => alert('Failed to fetch data from OpenLibrary.'));
});
</script>

<style>
  form input, form select, form textarea {
    border-radius: 0.4rem;
    border: 1px solid #ced4da;
    padding: 0.5rem 0.75rem;
    width: 100%;
  }
  form input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 5px rgba(13,110,253,0.2);
  }
</style>

{% endblock %}
