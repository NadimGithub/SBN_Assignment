{% extends "books/base.html" %}
{% block content %}
<h2>{{ action }} Book</h2>

<form method="post">
  {% csrf_token %}
  <div class="mb-3">
    <label>ISBN (optional)</label>
    <div class="input-group">
      {{ form.isbn }}
      <button id="fetch-btn" type="button" class="btn btn-outline-secondary">Fetch by ISBN</button>
    </div>
    <small class="text-muted">Click "Fetch by ISBN" to auto-fill Title/Author from OpenLibrary</small>
  </div>

  <div class="mb-3">
    <label>Title</label>
    {{ form.title }}
  </div>
  <div class="mb-3">
    <label>Author</label>
    {{ form.author }}
  </div>
  <div class="mb-3">
    <label>Price</label>
    {{ form.price }}
  </div>
  <button class="btn btn-primary" type="submit">{{ action }}</button>
  <a class="btn btn-secondary" href="{% url 'books:book_list' %}">Cancel</a>
</form>

<script>
document.getElementById('fetch-btn').addEventListener('click', function() {
  const isbnInput = document.getElementById('id_isbn');
  const isbn = isbnInput.value.trim();
  if (!isbn) {
    alert('Enter ISBN first');
    return;
  }
  fetch("{% url 'books:fetch_openlibrary' %}?isbn=" + encodeURIComponent(isbn))
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        document.getElementById('id_title').value = data.title || '';
        document.getElementById('id_author').value = data.author || '';
      }
    })
    .catch(() => alert('Failed to fetch from OpenLibrary'));
});
</script>
{% endblock %}
